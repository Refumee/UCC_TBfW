### base palette vs new palette: color changer with loyal unit option

#define OBJECT_OF_COLORCHANGER BASECOLOR NEWCOLOR ID
	[if]
		[have_unit]
			x,y=$unit_location[0].x,$unit_location[0].y
			[filter_wml]
				[modifications]
					[object]
						modification_scale_color_shift=yes
					[/object]
				[/modifications]
			[/filter_wml]
		[/have_unit]
		
		[then]
			[remove_object]
				x,y=$unit_location[0].x,$unit_location[0].y
				object_id=$unit_location[0].underlying_id
			[/remove_object]
		[/then]
		
		[else]
		[/else]
	[/if]
	
	[object]
		modification_scale_color_shift=yes
		modification_UCC_shift=yes
		modification_id={ID}
		silent=yes
		id=$unit_location[0].underlying_id
		duration=forever
		take_only_once=no
		[filter]
			x,y=$unit_location[0].x,$unit_location[0].y
		[/filter]
		
		[effect]
			apply_to=image_mod
			replace=PAL({BASECOLOR} > {NEWCOLOR})
		[/effect]
	[/object]
#enddef

### Advancement (if the advancements using a different set of pallets)

#define MODIFICATION_COLORCHANGER_ADVANCEMENT POST_ADVANCEMENT BASECOLOR NEWCOLOR ID
    [event]
        name=post advance
        first_time_only=no

        [filter]
            {POST_ADVANCEMENT}
			[filter_wml]
				[modifications]
					[object]
						modification_id={ID}
					[/object]
				[/modifications]
			[/filter_wml]
        [/filter]
				
		[remove_object]
			object_id=$unit.underlying_id
		[/remove_object]
		
		[object]
			modification_scale_color_shift=yes
			modification_id={ID}
			modification_UCC_shift=yes
			silent=yes
			id=$unit.underlying_id
			duration=forever
			take_only_once=no
			[filter]
				find_in=unit
				x,y=$x1,$y1
			[/filter]
			
			[effect]
				apply_to=image_mod
				replace=PAL({BASECOLOR} > {NEWCOLOR})
			[/effect]
		[/object]
    [/event]
#enddef

#define MODIFICATION_COLORCHANGER_ADVANCEMENT_SIDE POST_ADVANCEMENT BASECOLOR NEWCOLOR
    [event]
        name=post advance
        first_time_only=no

        [filter]
            {POST_ADVANCEMENT}
			[filter_wml]
				[modifications]
					[object]
						modification_id=SIDE
					[/object]
				[/modifications]
			[/filter_wml]
        [/filter]
	
		[for]
			array=color_side
			[do]
				[object]
					modification_scale_color_shift=yes
					modification_id=SIDE
					silent=yes
					id=$unit.underlying_id
					duration=forever
					take_only_once=no
					[filter]
						find_in=unit
						x,y=$x1,$y1
					[/filter]
					
					[effect]
						apply_to=image_mod
						replace=PAL({BASECOLOR} > {NEWCOLOR})
					[/effect]
				[/object]
			[/do]
		[/for]	
    [/event]
#enddef

#################################################################################################
################################## Picking a color side event ###################################
#################################################################################################

### code for imitate color change of all units of a whole side ###
#define COLORCHANGER_CHANGER_CODE_SIDE FILTER_WML BASECOLOR NEWCOLOR
		[modify_unit]
			[filter]
				{FILTER_WML}
				side=$unit_location[0].side
				[not]
					[filter_wml]
						[modifications]
							[object]
								modification_UCC_shift=yes
							[/object]
						[/modifications]
					[/filter_wml]
				[/not]
			[/filter]
			{COLORCHANGER_CHANGER_CODE_SIDE_HELPER {BASECOLOR} {NEWCOLOR}}
		[/modify_unit]
#enddef

#define COLORCHANGER_CHANGER_CODE_SIDE_HELPER BASECOLOR NEWCOLOR 
		[object]
			modification_scale_color_shift=yes
			modification_id=SIDE
			silent=yes
			id=$unit_location.underlying_id
			duration=forever
			
			[effect]
				apply_to=image_mod
				replace=PAL({BASECOLOR} > {NEWCOLOR})
			[/effect]
		[/object]
#enddef

### code for side recruitment ###
### it works through a list and checks which side got which color or if it is randomized ###
#define COLORCHANGER_RECRUIT_SIDE_CHANGER WML_FILTER BASECOLOR NEWCOLOR
    [event]
        name=unit placed
        first_time_only=no

        [filter]
            {WML_FILTER}
            [not]
                [filter_wml]
                    [modifications]
                        [object]
                            modification_scale_color_shift=yes
                        [/object]
                    [/modifications]
                [/filter_wml]
            [/not]
        [/filter]
		[filter_condition]
			{VARIABLE_CONDITIONAL colorchanger_sides_active equals yes}
		[/filter_condition]
		[for]
			array=color_side
			[do]
				{OBJECT_OF_COLORCHANGER_SIDE $color_side[$i].side {BASECOLOR} {NEWCOLOR}}
			[/do]
		[/for]	
    [/event]
#enddef

#define OBJECT_OF_COLORCHANGER_SIDE SIDE BASECOLOR NEWCOLOR
	[object]
		modification_scale_color_shift=yes
		modification_id=SIDE
		silent=yes
		id=$unit.underlying_id
		duration=forever
		take_only_once=no
		[filter]
			find_in=unit
			x,y=$x1,$y1
			side={SIDE}
		[/filter]
		
		[effect]
			apply_to=image_mod
			replace=PAL({BASECOLOR} > {NEWCOLOR})
		[/effect]
	[/object]
#enddef

#define COLORCHANGE_CLICK_MENU_ITEM_VARIABLE ID_EVENT YESNO TYPE
					[command]
						[store_unit]
							variable=unit_location
							[filter]
								x,y=$x1,$y1
							[/filter]
						[/store_unit]
						[store_side]
							variable=unit_side
							[filter]
								x,y=$x1,$y1
							[/filter]
						[/store_side]
						{VARIABLE unit_side_minus $unit_location[0].side}
						{VARIABLE_OP unit_side_minus sub 1}
						{VARIABLE single_unit_UCC {YESNO}}
						{VARIABLE UNITTYPE {TYPE}}
						[fire_event]
							id={ID_EVENT}
						[/fire_event]
						{CLEAR_VARIABLE unit_location}
						{CLEAR_VARIABLE unit_side}
						{CLEAR_VARIABLE unit_side_minus}
						{CLEAR_VARIABLE UNITTYPE}
					[/command]
#enddef

### Set menu item macro
#define COLORCHANGE_CLICK_MENU_ITEM ID ID2 FILTER_WML ID_EVENT TYPE
	[event]
        name=start
        [if]
            [variable]
                name=color_changer_ingame_allsides
                boolean_equals=yes
            [/variable]
			[then]
				[set_menu_item]
					id={ID}
					description=_"Color changer: single unit"
					[show_if]
						{VARIABLE_CONDITIONAL color_changer_ingame equals yes}
					[/show_if]
					[filter_location]
						[filter]
							{FILTER_WML}
							x,y=$x1,$y1
						[/filter]
					[/filter_location]
					{COLORCHANGE_CLICK_MENU_ITEM_VARIABLE {ID_EVENT} yes {TYPE} }
				[/set_menu_item]
				[set_menu_item]
					id={ID2}
					description=_"Color changer: whole faction"
					[show_if]
						{VARIABLE_CONDITIONAL color_changer_ingame_side equals yes}
					[/show_if]
					[filter_location]
						[filter]
							{FILTER_WML}
							x,y=$x1,$y1
						[/filter]
					[/filter_location]
					{COLORCHANGE_CLICK_MENU_ITEM_VARIABLE {ID_EVENT} no {TYPE} }
				[/set_menu_item]
			[/then]
            [else]
				[set_menu_item]
					id={ID}
					description=_"Color changer: single unit"
					[show_if]
						{VARIABLE_CONDITIONAL color_changer_ingame equals yes}
					[/show_if]
					[filter_location]
						[filter]
							side=$side_number
							{FILTER_WML}
							x,y=$x1,$y1
						[/filter]
					[/filter_location]
					{COLORCHANGE_CLICK_MENU_ITEM_VARIABLE {ID_EVENT} yes {TYPE} }
				[/set_menu_item]
				[set_menu_item]
					id={ID2}
					description=_"Color changer: whole faction"
					[show_if]
						{VARIABLE_CONDITIONAL color_changer_ingame_side equals yes}
					[/show_if]
					[filter_location]
						[filter]
							side=$side_number
							{FILTER_WML}
							x,y=$x1,$y1
						[/filter]
					[/filter_location]
					{COLORCHANGE_CLICK_MENU_ITEM_VARIABLE {ID_EVENT} no {TYPE} }
				[/set_menu_item]
			[/else]
		[/if]
	[/event]
#enddef